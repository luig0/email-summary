import Head from 'next/head';
import styles from '@/styles/Home.module.css';
import { useState } from 'react';

import LinkAccounts from '../components/LinkAccounts';

interface FormProps {
  setLoggedIn: (arg: boolean) => void;
  setShowLoginForm: (arg: boolean) => void;
}

const LoginForm = (props: FormProps) => {
  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    const username = (document.getElementById('username') as HTMLInputElement)?.value;
    const password = (document.getElementById('password') as HTMLInputElement)?.value;

    const res = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password }),
    });

    setLoginStatus(`${res.status} ${res.statusText}`);

    if (res.status === 200 && res.statusText === 'OK') setLoggedIn(true);
  };

  const { setLoggedIn, setShowLoginForm } = props;
  const [loginStatus, setLoginStatus] = useState('');

  return (
    <div style={{ textAlign: 'center', height: '400px' }}>
      <form onSubmit={handleSubmit}>
        <fieldset className={styles.fieldset}>
          <label>
            Username: <input type="text" name="username" id="username" />
          </label>
          <br />
          <label>
            Password: <input type="password" name="password" id="password" />
          </label>
          <br />
        </fieldset>
        <input type="submit" value="Submit" />
        <input type="button" value="Cancel" onClick={() => setShowLoginForm(false)} />
      </form>
      <br />
      {loginStatus.length > 0 && <span>{loginStatus}</span>}
      <br />
      <button onClick={() => setLoggedIn(true)}>Set logged in</button>
    </div>
  );
};

const RegistrationForm = (props: FormProps) => {
  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault();
    const username = (document.getElementById('username') as HTMLInputElement)?.value;
    const password = (document.getElementById('password') as HTMLInputElement)?.value;
    const inviteCode = (document.getElementById('invite-code') as HTMLInputElement)?.value;

    const res = await fetch('/api/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, inviteCode }),
    });

    if (res.status === 409) {
      setLoginStatus('That username is already taken!');
    } else {
      setLoginStatus(`${res.status} ${res.statusText}`);
    }

    if (res.status === 200 && res.statusText === 'OK') setLoggedIn(true);
  };

  const { setLoggedIn, setShowLoginForm } = props;
  const [loginStatus, setLoginStatus] = useState('');

  return (
    <div style={{ textAlign: 'center', height: '400px' }}>
      <form onSubmit={handleSubmit}>
        <fieldset className={styles.fieldset}>
          <label>
            Username: <input type="text" name="username" id="username" />
          </label>
          <br />
          <label>
            Password: <input type="password" name="password" id="password" />
          </label>
          <br />
          <label>
            Invitation Code: <input type="text" name="invite-code" id="invite-code" />
          </label>
          <br />
        </fieldset>
        <input type="submit" value="Submit" />
        <input type="button" value="Cancel" onClick={() => setShowLoginForm(false)} />
      </form>
      <br />
      {loginStatus.length > 0 && <span>{loginStatus}</span>}
      <br />
      <br />
      <button onClick={() => setLoggedIn(true)}>Set logged in</button>
    </div>
  );
};

const App = () => {
  const [loggedIn, setLoggedIn] = useState(false);
  const [showLoginForm, setShowLoginForm] = useState(false);
  const [showRegistrationForm, setShowRegistrationForm] = useState(false);

  if (loggedIn) {
    return <LinkAccounts />;
  } else {
    return (
      <div>
        <div style={{ margin: '20px', textAlign: 'center' }}>
          <button
            onClick={() => {
              setShowRegistrationForm(false);
              setShowLoginForm(true);
            }}
          >
            Login
          </button>
          <button
            onClick={() => {
              setShowLoginForm(false);
              setShowRegistrationForm(true);
            }}
          >
            Register
          </button>
        </div>
        <div>
          {showLoginForm && <LoginForm setLoggedIn={setLoggedIn} setShowLoginForm={setShowLoginForm} />}
          {showRegistrationForm && <RegistrationForm setLoggedIn={setLoggedIn} setShowLoginForm={setShowLoginForm} />}
        </div>
      </div>
    );
  }
};

export default function Home() {
  return (
    <>
      <Head>
        <title>CNA: joint-summary</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.main}>
        <App />
      </main>
    </>
  );
}
